{% extends "layouts/base.html" %}

{% block content %}
<h2>Quản lý người dùng</h2>

<!-- Nút Thêm Người Dùng động -->
<button id="addUserBtn" class="btn btn-primary mb-3">Thêm người dùng</button>
<div id="addUserFormsContainer"></div>

<!-- Danh sách người dùng -->
<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>ID</th>
      <th>Username</th>
      <th>Role</th>
      <th>Nodes</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for u in users %}
    <tr>
      <td>{{ u.id }}</td>
      <td>{{ u.username }}</td>
      <td>{{ u.role }}</td>
      <td>
        {% for un in u.user_nodes %}
          {{ un.node.hostname }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      </td>
      <td>
        <!-- Sửa -->
        <button class="btn btn-sm btn-warning editBtn" data-id="{{ u.id }}">Sửa</button>
        <!-- Xóa -->
        <form method="POST"
              action="{{ url_for('home_blueprint.delete_user', user_id=u.id) }}"
              style="display:inline;"
              onsubmit="return confirm('Bạn có chắc muốn xóa tài khoản {{ u.username }}?');">
          <button type="submit" class="btn btn-sm btn-danger">Xóa</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modal Sửa Người Dùng -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Chỉnh sửa người dùng</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- action sẽ được JS gán động -->
        <form id="editForm" method="POST" action="">
          <div class="form-group">
            <label for="edit_username">Tên đăng nhập</label>
            <input type="text" class="form-control" id="edit_username" name="username" required>
          </div>
          <div class="form-group">
            <label for="edit_role">Vai trò</label>
            <select class="form-control" id="edit_role" name="role" required>
              <option value="user">Người dùng</option>
              <option value="admin">Quản trị viên</option>
            </select>
          </div>
          <div class="form-group">
            <label>Chọn các node</label>
            <div>
              {% for node in nodes %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox"
                       id="node_{{ node.id }}" name="nodes" value="{{ node.id }}">
                <label class="form-check-label" for="node_{{ node.id }}">
                  {{ node.hostname }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
          <button type="submit" class="btn btn-success">Cập nhật</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Lấy template URL với user_id=0, sẽ replace sau
const updateUserUrlTemplate = "{{ url_for('home_blueprint.update_user', user_id=0) }}";


// 1) Xử lý nút Sửa
document.querySelectorAll('.editBtn').forEach(btn => {
  btn.addEventListener('click', () => {
    const userId = btn.getAttribute('data-id');
    fetch(`/get_user_data/${userId}`)
      .then(r => r.json())
      .then(data => {
        // Gán action cho form
        const form = document.getElementById('editForm');
        form.action = updateUserUrlTemplate.replace('/0', `/${userId}`);

        // Đặt lại input
        document.getElementById('edit_username').value = data.username;
        document.getElementById('edit_role').value = data.role;

        // Reset tất cả checkbox
        document.querySelectorAll('#editForm input[type="checkbox"]').forEach(ch => ch.checked = false);
        // Check theo data
        data.nodes.forEach(id => {
          const ch = document.getElementById(`node_${id}`);
          if (ch) ch.checked = true;
        });

        // Show modal
        $('#editModal').modal('show');
      })
      .catch(console.error);
  });
});


// 2) Xử lý nút Thêm người dùng động
let addFormCount = 0;
document.getElementById('addUserBtn').addEventListener('click', () => {
  const i = addFormCount++;
  const html = `
  <form class="add-user-form border p-3 mb-3" method="POST" action="{{ url_for('home_blueprint.manage_users') }}">
    <h5>Người dùng ${i+1}</h5>
    <div class="form-group">
      <label for="username_${i}">Username</label>
      <input type="text" class="form-control" id="username_${i}" name="username_${i}" required>
    </div>
    <div class="form-group">
      <label for="password_${i}">Mật khẩu</label>
      <input type="password" class="form-control" id="password_${i}" name="password_${i}" required>
    </div>
    <div class="form-group">
      <label for="role_${i}">Vai trò</label>
      <select class="form-control" id="role_${i}" name="role_${i}" required>
        <option value="user">Người dùng</option>
        <option value="admin">Quản trị viên</option>
      </select>
    </div>
    <div class="form-group">
      <label>Chọn các node</label>
      <div>
        {% for node in nodes %}
        <div class="form-check">
          <input class="form-check-input" type="checkbox"
                 id="add_${i}_node_{{ node.id }}" name="nodes_${i}" value="{{ node.id }}">
          <label class="form-check-label" for="add_${i}_node_{{ node.id }}">
            {{ node.hostname }}
          </label>
        </div>
        {% endfor %}
      </div>
    </div>
    <button type="submit" class="btn btn-success">Thêm</button>
  </form>`;
  document.getElementById('addUserFormsContainer').insertAdjacentHTML('beforeend', html);
});
</script>
{% endblock %}