{% extends "layouts/base.html" %}

{% block content %}
<h2>Quản lý người dùng</h2>

<button id="addUserBtn" class="btn btn-primary">Thêm người dùng</button>

<div id="addUserFormsContainer"></div>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Tên đăng nhập</th>
            <th>Vai trò</th>
            <th>Quản lý các node</th>
            <th>Hành động</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr>
            <td>{{ user.id }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.role }}</td>
            <td>
                {% for user_node in user_nodes if user_node.user_id == user.id %}
                    {{ nodes[user_node.node_id].hostname }} ({{ user_node.role }})
                {% endfor %}
            </td>
            <td>
                <button class="btn btn-warning editBtn" data-id="{{ user.id }}">Sửa</button>
                <button class="btn btn-danger deleteBtn" data-id="{{ user.id }}">Xóa</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal Thêm Người Dùng -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">Thêm người dùng mới</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="addUserForm" method="POST">
            <div class="form-group">
                <label for="username">Tên đăng nhập</label>
                <input type="text" class="form-control" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Mật khẩu</label>
                <input type="password" class="form-control" name="password" required>
            </div>
            <div class="form-group">
                <label for="role">Vai trò</label>
                <select class="form-control" name="role" required>
                    <option value="user">Người dùng</option>
                    <option value="admin">Quản trị viên</option>
                </select>
            </div>
            <div class="form-group">
                <label>Chọn các node</label>
                <div>
                    {% for node in nodes %}
                        <div>
                            <input type="checkbox" name="nodes" value="{{ node.id }}" {% if node.id in selected_node_ids %}checked{% endif %}>
                            <label>{{ node.hostname }}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <button type="submit" class="btn btn-success">Thêm</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Sửa Người Dùng -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Chỉnh sửa người dùng</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editForm" method="POST">
            <input type="hidden" id="editUserId" name="user_id">
            <div class="form-group">
                <label for="editUsername">Tên đăng nhập</label>
                <input type="text" class="form-control" id="editUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="editRole">Vai trò</label>
                <select class="form-control" id="editRole" name="role" required>
                    <option value="user">Người dùng</option>
                    <option value="admin">Quản trị viên</option>
                </select>
            </div>
            <div class="form-group">
                <label>Chọn các node</label>
                <div>
                    {% for node in nodes %}
                    <div>
                        <input type="checkbox" name="nodes" value="{{ node.id }}">
                        <label>{{ node.hostname }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" class="btn btn-success">Cập nhật</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Xóa Người Dùng -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa người dùng</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn xóa người dùng này không?</p>
        <form id="deleteForm" method="POST">
            <input type="hidden" id="deleteUserId" name="user_id">
            <div class="form-group">
                <label for="password">Nhập lại mật khẩu để xác nhận</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-danger">Xóa</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    // Mã JavaScript xử lý thêm, sửa, xóa người dùng
    // Xử lý thêm người dùng
    document.getElementById('addUserBtn').addEventListener('click', function() {
        $('#addUserModal').modal('show');
    });

    // Xử lý sửa người dùng
    document.querySelectorAll('.editBtn').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-id');
            fetch(`/get_user_data/${userId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('editUserId').value = data.id;
                    document.getElementById('editUsername').value = data.username;
                    document.getElementById('editRole').value = data.role;
                    data.nodes.forEach(nodeId => {
                        document.querySelector(`input[name="nodes"][value="${nodeId}"]`).checked = true;
                    });
                    $('#editModal').modal('show');
                });
        });
    });

    // Xử lý xóa người dùng
    document.querySelectorAll('.deleteBtn').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-id');
            document.getElementById('deleteUserId').value = userId;
            $('#deleteModal').modal('show');
        });
    });

    // Xử lý xác nhận xóa người dùng
    document.getElementById('deleteForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const userId = document.getElementById('deleteUserId').value;
        const password = document.getElementById('password').value;
        fetch(`/delete_user/${userId}`, {
            method: 'POST',
            body: new URLSearchParams({ 'password': password }),
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Xóa người dùng thất bại');
            }
        });
    });
</script>

{% endblock %}
