{% extends "layouts/base.html" %}
{% block content %}
<h2>Quản lý người dùng</h2>

<button id="addUserBtn" class="btn btn-primary mb-3">Thêm người dùng</button>
<div id="addUserFormsContainer"></div>

<table class="table table-striped">
  <thead>
    <tr><th>ID</th><th>Username</th><th>Role</th><th>Nodes</th><th>Actions</th></tr>
  </thead>
  <tbody>
    {% for u in users %}
    <tr>
      <td>{{ u.id }}</td>
      <td>{{ u.username }}</td>
      <td>{{ u.role }}</td>
      <td>
        {% for un in u.user_nodes %}
          {{ un.node.hostname }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      </td>
      <td>
        <button class="btn btn-sm btn-warning editBtn" data-id="{{ u.id }}">Sửa</button>
        <form method="POST"
              action="{{ url_for('home_blueprint.delete_user', user_id=u.id) }}"
              style="display:inline"
              onsubmit="return confirm('Xác nhận xóa {{ u.username }}?');">
          <button class="btn btn-sm btn-danger">Xóa</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modal Edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editForm" method="POST" action="">
        <div class="modal-header">
          <h5 class="modal-title">Chỉnh sửa người dùng</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Username</label>
            <input type="text" class="form-control" name="username" id="edit_username" required>
          </div>
          <div class="form-group">
            <label>Mật khẩu mới (để trống nếu không đổi)</label>
            <input type="password" class="form-control" name="password" id="edit_password">
          </div>
          <div class="form-group">
            <label>Role</label>
            <select class="form-control" name="role" id="edit_role">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div class="form-group">
            <label>Nodes</label>
            <div>
              {% for node in nodes %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox"
                       name="nodes" value="{{ node.id }}" id="node_{{ node.id }}">
                <label class="form-check-label" for="node_{{ node.id }}">
                  {{ node.hostname }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-dismiss="modal">Hủy</button>
          <button class="btn btn-primary">Lưu thay đổi</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// URL mẫu sẽ thành e.g. "/home/update_user/0"
const updateUserUrlTpl = "{{ url_for('home_blueprint.update_user', user_id=0) }}";

// btn Edit click
document.querySelectorAll('.editBtn').forEach(btn => {
  btn.addEventListener('click', () => {
    const uid = btn.dataset.id;
    fetch(`{{ url_for('home_blueprint.get_user_data', user_id=0) }}`.replace('/0','/'+uid))
      .then(r => r.json())
      .then(data => {
        // Fill form
        const f = document.getElementById('editForm');
        f.action = updateUserUrlTpl.replace('/0','/'+uid);
        document.getElementById('edit_username').value = data.username;
        document.getElementById('edit_password').value = '';
        document.getElementById('edit_role').value = data.role;

        // clear all
        document.querySelectorAll('#editForm input[type=checkbox]')
                .forEach(ch => ch.checked = false);
        // check theo data.nodes
        data.nodes.forEach(nid => {
          const ch = document.getElementById('node_'+nid);
          if(ch) ch.checked = true;
        });

        $('#editModal').modal('show');
      });
  });
});

// (Phần thêm user mới giữ nguyên hoặc tùy bạn)
</script>
{% endblock %}